<Window x:Class="DbDesigner.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:DbDesigner.App.ViewModels"
        xmlns:avalonEdit="http://icsharpcode.net/sharpdevelop/avalonedit"
        xmlns:local="clr-namespace:DbDesigner.App"
        xmlns:helpers="clr-namespace:DbDesigner.App.Helpers"
        mc:Ignorable="d"
        Title="DbDesigner" Height="720" Width="1100"
        >
    <Window.DataContext>
        <vm:MainViewModel />
    </Window.DataContext>

    <Grid Background="{DynamicResource SurfaceBrush}">
        <TabControl HorizontalAlignment="Stretch">
            <TabItem Header="Polaczenie" Tag="ðŸ”Œ">
                <Grid Margin="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,0,8">
                        <TextBlock Text="Tryb polaczenia:" VerticalAlignment="Center" />
                        <RadioButton Content="Demo (SQLite)"
                                     Margin="12,0,0,0"
                                     IsChecked="{Binding Connection.IsDemoMode, Mode=TwoWay}" />
                        <RadioButton Content="MSSQL"
                                     Margin="12,0,0,0"
                                     IsChecked="{Binding Connection.IsSqlServerMode, Mode=TwoWay}" />
                    </StackPanel>

                    <Border Grid.Row="1"
                            Style="{StaticResource CardStyle}"
                            Visibility="{Binding Connection.IsDemoMode, Converter={StaticResource BoolToVisibilityConverter}}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <TextBlock Text="Polaczenie demo (SQLite)" FontWeight="Bold" FontSize="14" />
                            <TextBox Grid.Row="1"
                                     Margin="0,8,0,0"
                                     Width="650"
                                     Text="{Binding Connection.ConnectionString, UpdateSourceTrigger=PropertyChanged}" />
                            <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,10,0,0">
                                <Button Content="Utworz przykladowa baze CRM"
                                        Command="{Binding Connection.CreateSampleCrmDatabaseCommand}" />
                                <Button Content="Polacz i wczytaj schemat"
                                        Margin="8,0,0,0"
                                        Command="{Binding Connection.LoadSchemaCommand}" />
                            </StackPanel>
                        </Grid>
                    </Border>

                    <Border Grid.Row="1"
                            Style="{StaticResource CardStyle}"
                            Visibility="{Binding Connection.IsSqlServerMode, Converter={StaticResource BoolToVisibilityConverter}}">
                        <StackPanel>
                            <TextBlock Text="Polaczenie MSSQL" FontWeight="Bold" FontSize="14" />
                            <TextBlock Text="Server" Margin="0,8,0,0" />
                            <TextBox Margin="0,4,0,0"
                                     Text="{Binding Connection.SqlServerName, UpdateSourceTrigger=PropertyChanged}" />
                            <TextBlock Text="Database" Margin="0,8,0,0" />
                            <TextBox Margin="0,4,0,0"
                                     Text="{Binding Connection.SqlServerDatabase, UpdateSourceTrigger=PropertyChanged}" />
                            <TextBlock Text="User" Margin="0,8,0,0" />
                            <TextBox Margin="0,4,0,0"
                                     Text="{Binding Connection.SqlServerUser, UpdateSourceTrigger=PropertyChanged}" />
                            <TextBlock Text="Password" Margin="0,8,0,0" />
                            <PasswordBox Margin="0,4,0,0"
                                         local:PasswordBoxHelper.BindPassword="True"
                                         local:PasswordBoxHelper.BindablePassword="{Binding Connection.SqlServerPassword, Mode=TwoWay}" />
                            <TextBlock Text="Sposob logowania" Margin="0,8,0,0" />
                            <ComboBox Margin="0,4,0,0"
                                      SelectedValue="{Binding Connection.AuthenticationMode, Mode=TwoWay}"
                                      SelectedValuePath="Tag">
                                <ComboBoxItem Content="SQL Authentication" Tag="{x:Static vm:SqlAuthenticationMode.SqlAuthentication}" />
                                <ComboBoxItem Content="Windows Authentication" Tag="{x:Static vm:SqlAuthenticationMode.WindowsAuthentication}" />
                            </ComboBox>
                            <TextBlock Text="Zaawansowane" FontWeight="Bold" Margin="0,12,0,0" />
                            <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                <CheckBox Content="Encrypt"
                                          IsChecked="{Binding Connection.Encrypt, Mode=TwoWay}" />
                                <CheckBox Content="TrustServerCertificate"
                                          Margin="12,0,0,0"
                                          IsChecked="{Binding Connection.TrustServerCertificate, Mode=TwoWay}" />
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                                <Button Content="Testuj polaczenie"
                                        Command="{Binding Connection.TestSqlServerConnectionCommand}" />
                                <Button Content="Polacz i wczytaj schemat (MSSQL)"
                                        Margin="8,0,0,0"
                                        Command="{Binding Connection.ConnectSqlServerCommand}" />
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <TextBlock Grid.Row="2"
                               Margin="0,8,0,0"
                               Text="{Binding Connection.StatusMessage}" />

                    <Border Grid.Row="3"
                            Style="{StaticResource CardStyle}">
                        <StackPanel>
                            <TextBlock Text="Wskazowka"
                                       FontWeight="Bold" />
                            <TextBlock Text="{Binding Connection.HintText}"
                                       TextWrapping="Wrap"
                                       Margin="0,4,0,0" />
                        </StackPanel>
                    </Border>
                </Grid>
            </TabItem>

                        <TabItem Header="Schemat i zaleznosci" Tag="??">
                <Grid Margin="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="260"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Border Grid.Row="0" Grid.ColumnSpan="2" Style="{StaticResource CardStyle}">
                        <StackPanel>
                            <TextBlock Text="Filtry schematu" FontWeight="Bold" FontSize="14" />
                            <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                                <StackPanel Width="200" Margin="0,0,8,0">
                                    <TextBlock Text="Obiekt" />
                                    <TextBox Text="{Binding Schema.FilterObjectName, UpdateSourceTrigger=PropertyChanged}" />
                                </StackPanel>
                                <StackPanel Width="200">
                                    <TextBlock Text="Schema" />
                                    <TextBox Text="{Binding Schema.FilterSchemaName, UpdateSourceTrigger=PropertyChanged}" />
                                </StackPanel>
                            </StackPanel>

                            <DataGrid ItemsSource="{Binding Schema.SchemaObjects}"
                                      Margin="0,10,0,0"
                                      AutoGenerateColumns="False"
                                      CanUserAddRows="False"
                                      CanUserDeleteRows="False"
                                      IsReadOnly="True"
                                      HeadersVisibility="Column">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Schema" Binding="{Binding SchemaName}" Width="120"/>
                                    <DataGridTextColumn Header="Obiekt" Binding="{Binding ObjectName}" Width="*"/>
                                    <DataGridTextColumn Header="Typ" Binding="{Binding ObjectType}" Width="120"/>
                                    <DataGridTextColumn Header="Dependencies" Binding="{Binding Dependencies}" Width="220"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </StackPanel>
                    </Border>

                    <Border Grid.Row="1" Style="{StaticResource CardStyle}" Margin="0,0,12,0">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0">
                                <TextBlock Text="Tabele" FontWeight="Bold" />
                                <ListBox ItemsSource="{Binding Schema.Tables}"
                                         SelectedItem="{Binding Schema.SelectedTable}"
                                         DisplayMemberPath="Name"
                                         Margin="0,6,0,0"/>
                            </StackPanel>

                            <StackPanel Grid.Row="1" Margin="0,8,0,0">
                                <TextBlock Text="Widoki" FontWeight="Bold" />
                                <ListBox ItemsSource="{Binding Schema.Views}"
                                         SelectedItem="{Binding Schema.SelectedView}"
                                         DisplayMemberPath="Name"
                                         Margin="0,6,0,0"/>
                            </StackPanel>

                            <TextBlock Grid.Row="2" Text="{Binding Schema.Summary}" Margin="0,8,0,0" />
                        </Grid>
                    </Border>

                    <Grid Grid.Row="1" Grid.Column="1">
                        <StackPanel Visibility="{Binding Schema.IsTableSelected, Converter={StaticResource BoolToVisibilityConverter}}">
                            <TextBlock Text="{Binding Schema.SelectedTable.Name}"
                                       FontSize="16"
                                       FontWeight="Bold" />

                            <GroupBox Header="Kolumny">
                                <DataGrid ItemsSource="{Binding Schema.Columns}"
                                          AutoGenerateColumns="False"
                                          CanUserAddRows="False"
                                          CanUserDeleteRows="False"
                                          HeadersVisibility="Column"
                                          IsReadOnly="True">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Nazwa" Binding="{Binding Name}" Width="*"/>
                                        <DataGridTextColumn Header="Typ" Binding="{Binding DataType}" Width="*"/>
                                        <DataGridCheckBoxColumn Header="PK" Binding="{Binding IsPrimaryKey}" Width="60"/>
                                        <DataGridCheckBoxColumn Header="NULL" Binding="{Binding IsNullable}" Width="60"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </GroupBox>

                            <GroupBox Header="Klucze obce (wychodzace)">
                                <ItemsControl ItemsSource="{Binding Schema.ForeignKeys}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock>
                                                <TextBlock.Text>
                                                    <MultiBinding StringFormat="{}{0}.{1} -> {2}.{3}">
                                                        <Binding Path="FromTable"/>
                                                        <Binding Path="FromColumn"/>
                                                        <Binding Path="ToTable"/>
                                                        <Binding Path="ToColumn"/>
                                                    </MultiBinding>
                                                </TextBlock.Text>
                                            </TextBlock>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </GroupBox>

                            <GroupBox Header="Tabela wskazywana przez inne FK">
                                <ItemsControl ItemsSource="{Binding Schema.IncomingForeignKeys}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock>
                                                <TextBlock.Text>
                                                    <MultiBinding StringFormat="{}{0}.{1} -> {2}.{3}">
                                                        <Binding Path="FromTable"/>
                                                        <Binding Path="FromColumn"/>
                                                        <Binding Path="ToTable"/>
                                                        <Binding Path="ToColumn"/>
                                                    </MultiBinding>
                                                </TextBlock.Text>
                                            </TextBlock>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </GroupBox>
                        </StackPanel>

                        <StackPanel Visibility="{Binding Schema.IsViewSelected, Converter={StaticResource BoolToVisibilityConverter}}">
                            <TextBlock Text="{Binding Schema.SelectedView.Name}"
                                       FontSize="16"
                                       FontWeight="Bold" />

                            <GroupBox Header="Definicja widoku">
                                <avalonEdit:TextEditor x:Name="ViewDefinitionEditor"
                                                       FontFamily="Consolas"
                                                       FontSize="12"
                                                       IsReadOnly="True"
                                                       ShowLineNumbers="True"
                                                       VerticalScrollBarVisibility="Auto"
                                                       Height="220"
                                                       helpers:AvalonEditBinding.BoundText="{Binding Schema.SelectedView.Definition}" />
                            </GroupBox>

                            <GroupBox Header="Tabele uzyte w widoku">
                                <ItemsControl ItemsSource="{Binding Schema.ViewTables}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding}" />
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </GroupBox>

                            <GroupBox Header="Inne zaleznosci (widoki/funkcje)">
                                <ItemsControl ItemsSource="{Binding Schema.ViewDependencies}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding}" />
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </GroupBox>
                        </StackPanel>
                    </Grid>
                </Grid>
            </TabItem>

            <TabItem Header="Chat AI / projektant zmian" Tag="ðŸ¤–">
                <StackPanel Margin="12">
                    <Border Style="{StaticResource CardStyle}">
                        <StackPanel>
                            <TextBlock Text="Specyfikacja zmian w bazie" FontWeight="Bold" FontSize="14" />
                            <TextBox Text="{Binding DesignChanges.SpecificationText, UpdateSourceTrigger=PropertyChanged}"
                                     AcceptsReturn="True"
                                     Margin="0,6,0,0"
                                     VerticalScrollBarVisibility="Auto"
                                     Height="160"
                                     TextWrapping="Wrap"/>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,8,0,0">
                                <Button Content="Zaproponuj zmiany"
                                        Command="{Binding DesignChanges.ProposeChangesCommand}" />
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <Border Style="{StaticResource CardStyle}">
                        <StackPanel>
                            <TextBlock Text="Proponowane zmiany" FontWeight="Bold" FontSize="14" />
                            <DataGrid x:Name="ProposedChangesGrid"
                                      ItemsSource="{Binding DesignChanges.ProposedChanges}"
                                      Margin="0,6,0,0"
                                      AutoGenerateColumns="False"
                                      CanUserAddRows="False"
                                      CanUserDeleteRows="False"
                                      IsReadOnly="False">
                                <DataGrid.Columns>
                                    <DataGridCheckBoxColumn Header="Use" Binding="{Binding IsSelected, Mode=TwoWay}" Width="60"/>
                                    <DataGridTextColumn Header="Schema" Binding="{Binding SchemaName}" Width="100"/>
                                    <DataGridTextColumn Header="Obiekt" Binding="{Binding ObjectName}" Width="180"/>
                                    <DataGridTextColumn Header="Typ" Binding="{Binding Change.GetType().Name}" Width="140"/>
                                    <DataGridTextColumn Header="Opis" Binding="{Binding Change.Description}" Width="*"/>
                                </DataGrid.Columns>
                            </DataGrid>
                            <TextBlock Text="{Binding DesignChanges.StatusMessage}" Margin="0,8,0,0">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Foreground" Value="{DynamicResource TextBrush}" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding DesignChanges.IsStatusError}" Value="True">
                                                <Setter Property="Foreground" Value="Tomato" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </TabItem>

            <TabItem Header="SQL i wykonanie" Tag="ðŸ§¾">
                <Grid Margin="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <avalonEdit:TextEditor
                        x:Name="SqlPreviewEditor"
                        Grid.Row="0"
                        Margin="0,0,0,8"
                        IsReadOnly="True"
                        FontFamily="Consolas"
                        FontSize="12"
                        ShowLineNumbers="True"
                        VerticalScrollBarVisibility="Auto"
                        helpers:AvalonEditBinding.BoundText="{Binding ScriptPreview.GeneratedScript, Mode=OneWay}" />

                    <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right">
                        <TextBlock Text="{Binding ScriptPreview.StatusMessage}"
                                   VerticalAlignment="Center"
                                   HorizontalAlignment="Left"
                                   Margin="0,0,12,0"/>
                        <Button Content="Zapisz do pliku..."
                                Command="{Binding ScriptPreview.SaveToFileCommand}"/>
                        <Button Content="Wykonaj na bazie"
                                Margin="8,0,0,0"
                                Command="{Binding ScriptPreview.ExecuteOnDatabaseCommand}"/>
                    </StackPanel>
                </Grid>
            </TabItem>

            <TabItem Header="Ustawienia" Tag="âš™ï¸">
                <StackPanel Margin="12">
                    <Border Style="{StaticResource CardStyle}">
                        <StackPanel>
                            <TextBlock Text="Motyw aplikacji" FontWeight="Bold" FontSize="14" />
                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                <RadioButton Content="Jasny"
                                             IsChecked="{Binding Settings.IsLightTheme}" />
                                <RadioButton Content="Ciemny"
                                             Margin="12,0,0,0"
                                             IsChecked="{Binding Settings.IsDarkTheme}" />
                            </StackPanel>
                            <Button Content="Zastosuj motyw"
                                    Margin="0,8,0,0"
                                    HorizontalAlignment="Left"
                                    Command="{Binding Settings.ApplyThemeCommand}" />
                        </StackPanel>
                    </Border>

                    <Border Style="{StaticResource CardStyle}">
                        <StackPanel>
                            <TextBlock Text="Tryb czatu AI" FontWeight="Bold" FontSize="14" />
                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                <RadioButton Content="Lokalny (stub)"
                                             IsChecked="{Binding Settings.IsLocalChat}" />
                                <RadioButton Content="API"
                                             Margin="12,0,0,0"
                                             IsChecked="{Binding Settings.IsApiChat}" />
                            </StackPanel>
                            <TextBlock Text="Tryb API w przygotowaniu (zmiana przelacza etykiety w UI)."
                                       Margin="0,8,0,0"
                                       TextWrapping="Wrap" />
                        </StackPanel>
                    </Border>

                    <Border Style="{StaticResource CardStyle}"
                            Visibility="{Binding Settings.IsApiChat, Converter={StaticResource BoolToVisibilityConverter}}">
                        <StackPanel>
                            <TextBlock Text="Ustawienia API dla czatu AI" FontWeight="Bold" FontSize="14" />
                            <TextBlock Text="Endpoint API" Margin="0,8,0,0" />
                            <TextBox Margin="0,4,0,0"
                                     Text="{Binding Settings.ApiBaseUrl, UpdateSourceTrigger=PropertyChanged}" />
                            <TextBlock Text="API key" Margin="0,8,0,0" />
                            <PasswordBox Margin="0,4,0,0"
                                         local:PasswordBoxHelper.BindPassword="True"
                                         local:PasswordBoxHelper.BindablePassword="{Binding Settings.ApiKey, Mode=TwoWay}" />
                        </StackPanel>
                    </Border>
                </StackPanel>
            </TabItem>
        </TabControl>
    </Grid>
</Window>

